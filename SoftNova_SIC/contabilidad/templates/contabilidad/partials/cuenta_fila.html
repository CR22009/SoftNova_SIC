{% load auth_extras %}
<!-- 
Este archivo parcial se llama a sí mismo para mostrar la jerarquía de cuentas.
Recibe 'cuenta' y 'indent_level' del template padre.
-->
<tr class="{% if not cuenta.es_imputable %}bg-gray-50{% endif %} {% if not cuenta.esta_activa %}opacity-50{% endif %}">
    
    <!-- Código -->
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if cuenta.es_imputable %}text-gray-900{% else %}text-gray-500{% endif %}">
        <span class="pl-{{ indent_level }}">{{ cuenta.codigo }}</span>
    </td>
    
    <!-- Nombre -->
    <td class="px-6 py-4 whitespace-nowrap text-sm {% if cuenta.es_imputable %}text-gray-900{% else %}text-gray-500{% endif %}">
        <span class="font-semibold {% if not cuenta.esta_activa %}line-through{% endif %}">{{ cuenta.nombre }}</span>
        {% if not cuenta.es_imputable %}
            <!-- Botón para añadir sub-cuenta (hija) -->
            {% if user|has_group:"Administrador" and cuenta.esta_activa %}
                <a href="{% url 'contabilidad:crear_cuenta_hija' cuenta.id %}" title="Añadir sub-cuenta" 
                   class="ml-2 text-sic-primary opacity-50 hover:opacity-100">
                    <ion-icon name="add-circle-outline"></ion-icon>
                </a>
            {% endif %}
        {% endif %}
    </td>
    
    <!-- Tipo -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ cuenta.get_tipo_cuenta_display }}</td>
    
    <!-- Imputable -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        {% if cuenta.es_imputable %}
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                Sí
            </span>
        {% else %}
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                No (Grupo)
            </span>
        {% endif %}
    </td>
    
    <!-- Estado (Activa/Inactiva) -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        {% if cuenta.esta_activa %}
            <span class="text-green-600">Activa</span>
        {% else %}
            <span class="text-red-600 font-medium">Inactiva</span>
        {% endif %}
    </td>
    
    <!-- Acciones (Solo Admin) -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        {% if user|has_group:"Administrador" %}
            <div class="flex items-center space-x-3">
                <!-- Botón Editar -->
                <a href="{% url 'contabilidad:editar_cuenta' cuenta.id %}" class="text-blue-600 hover:text-blue-900" title="Editar Cuenta">
                    <ion-icon name="pencil-outline" class="text-xl"></ion-icon>
                </a>
                
                <!-- Botón Eliminar (Desactivar) -->
                {% if cuenta.esta_activa %}
                <form action="{% url 'contabilidad:eliminar_cuenta' cuenta.id %}" method="POST"
                      onsubmit="return confirm('¿Estás SEGURO de que quieres eliminar (desactivar) la cuenta {{ cuenta.nombre }}?\n\nSolo se permitirá si la cuenta no tiene saldo y no tiene sub-cuentas activas.');">
                    {% csrf_token %}
                    <button type="submit" class="text-red-600 hover:text-red-900" title="Eliminar (Desactivar) Cuenta">
                        <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                    </button>
                </form>
                {% endif %}
            </div>
        {% endif %}
    </td>
</tr>

<!-- Recursión: Si la cuenta tiene hijos, llama a este mismo template para cada hijo -->
{% for hijo in cuenta.hijos.all %}
    {% include "contabilidad/partials/cuenta_fila.html" with cuenta=hijo indent_level=indent_level|add:4 %}
{% endfor %}

